/*
 * Creative Commons Copyright 2013 Ursudio <info@ursudio.com>
 * http://www.ursudio.com/
 * Please attribute Ursudio in any production associated with this javascript plugin.
 */
L.TileLayer.WebGLHeatMap=L.Class.extend({options:{size:3e4,opacity:1,gradientTexture:!1,alphaRange:1},initialize:function(t){this.data=[],L.Util.setOptions(this,t)},onAdd:function(t){this.map=t
var a=t.getSize(),e=this.options,i=document.createElement("canvas")
i.id="webgl-leaflet-"+L.Util.stamp(this),i.width=a.x,i.height=a.y,i.style.opacity=e.opacity,i.style.position="absolute",t.getPanes().overlayPane.appendChild(i),this.WebGLHeatMap=createWebGLHeatmap({canvas:i,gradientTexture:e.gradientTexture,alphaRange:[0,e.alphaRange]}),this.canvas=i,t.on("move",this._plot,this),t.on("zoomstart",this._hide,this),t.on("zoomend",this._show,this),this._plot()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this.canvas),t.off("move",this._plot,this),t.off("zoomstart",this._hide,this),t.off("zoomend",this._show,this)},_hide:function(){this.canvas.style.display="none"},_show:function(){this.canvas.style.display="block"},_clear:function(){var t=this.WebGLHeatMap
t.clear(),t.display()},_resizeRequest:void 0,_plot:function(){this.active=!0
var t=this.map
this._resizeRequest!==t._resizeRequest&&(this.resize(),this._resizeRequest=t._resizeRequest)
var a=this.WebGLHeatMap
a.clear(),L.DomUtil.setPosition(this.canvas,t.latLngToLayerPoint(t.getBounds().getNorthWest()))
var e=this.data.length
if(e){for(var i=0;e>i;i++){var s=this.data[i],n=new L.LatLng(s[0],s[1]),o=t.latLngToContainerPoint(n)
a.addPoint(Math.floor(o.x),Math.floor(o.y),4===s.length?s[3]:this.scale(n),s[2])}a.update(),a.display()}},scale:function(t,a){var e=360*(a?a:this.options.size/40075017)/Math.cos(L.LatLng.DEG_TO_RAD*t.lat),i=new L.LatLng(t.lat,t.lng-e),s=this.map.latLngToLayerPoint(t),n=this.map.latLngToLayerPoint(i)
return Math.max(Math.round(s.x-n.x),1)},resize:function(){var t=this.map.getSize()
this.canvas.width=t.x,this.canvas.height=t.y,this.WebGLHeatMap.adjustSize()},addDataPoint:function(t,a,e,i){this.data.push(i?[t,a,e,i]:[t,a,e])},setData:function(t){this.data=t},clearData:function(){this.data=[]},update:function(){this._plot()}}),L.TileLayer.webglheatmap=function(t){return new L.TileLayer.WebGLHeatMap(t)}
